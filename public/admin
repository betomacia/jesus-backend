<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin Push</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding:16px; max-width:980px; margin:0 auto; }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:13px; }
    th { background:#fafafa; position: sticky; top: 0; }
    .btn { padding:8px 12px; border-radius:10px; border:none; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-green { background:#16a34a; color:#fff; }
    .btn-gray { background:#111827; color:#fff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#f3f4f6; }
    .muted { color:#6b7280; font-size:12px }
    textarea, input[type="text"] { width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; }
    .hint { font-size:12px; color:#6b7280; }
    .ok { color:#16a34a; }
    .err { color:#dc2626; }
    .scroll { max-height: 340px; overflow: auto; }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1d4ed8; }
    .badge-android { background:#ecfeff; color:#0891b2; }
    .badge-desktop { background:#fef3c7; color:#b45309; }
    pre { background:#0b1020; color:#c7d2fe; padding:10px; border-radius:8px; font-size:12px; overflow:auto; }
  </style>
</head>
<body>

  <h1>Admin Push</h1>

  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <label>Email:&nbsp;<input id="email" type="text" value="info@movilive.com" style="min-width:260px"></label>
      <label>Admin Key:&nbsp;<input id="admkey" type="text" value="abc123" style="min-width:180px"></label>
      <button id="btnLoad" class="btn btn-gray">Cargar dispositivos</button>
      <span id="counters" class="muted"></span>
    </div>
    <div id="loadMsg" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card" style="margin-bottom:12px">
    <div class="row" style="align-items:flex-start; gap:16px">
      <div style="flex:1; min-width:260px">
        <label>T√≠tulo<br><input id="title" type="text" placeholder="T√≠tulo" value="Hola üëã"></label>
      </div>
      <div style="flex:2; min-width:280px">
        <label>Mensaje<br><textarea id="body" rows="3" placeholder="Texto a mostrar">Prueba push desde admin</textarea></label>
      </div>
      <div style="flex:1; min-width:220px">
        <label>Destino<br>
          <select id="aud" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;">
            <option value="all">Todos</option>
            <option value="web">Solo Desktop/Web</option>
            <option value="android">Solo Android</option>
            <option value="selected">Seleccionados (checkbox)</option>
          </select>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnSend" class="btn btn-primary">Enviar</button>
      <div class="hint">Android recibir√° <b>notificaci√≥n visible</b>. Desktop/Web recibir√° <b>data-only</b> para evitar duplicados.</div>
    </div>
    <div id="sendMsg" style="margin-top:6px"></div>
  </div>

  <div class="card" style="margin-bottom:12px">
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Dispositivos</b>
        <span class="muted">(Us√° ‚ÄúCargar dispositivos‚Äù para refrescar)</span>
      </div>
      <div class="muted">Android PWA aparece como plataforma ‚Äúweb‚Äù, lo distinguimos por <code>device_id</code> (empieza con <b>ANDROID_CHROME_</b>).</div>
    </div>
    <div class="scroll">
      <table id="devTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="chkAll"></th>
            <th>ID</th>
            <th>device_id</th>
            <th>platform</th>
            <th>last_seen</th>
            <th>token (inicio)</th>
          </tr>
        </thead>
        <tbody id="devBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div><b>Diagn√≥stico</b> <span class="muted">(ayuda a ver qu√© devuelve el backend)</span></div>
    <div class="row" style="margin-top:8px">
      <button id="btnDiag" class="btn btn-green">Volcar respuesta cruda</button>
      <span class="muted">Si ‚ÄúDesktop/Web‚Äù da <code>targeted: 0</code>, revis√° que ac√° aparezca un device con <b>WEB_DESKTOP_‚Ä¶</b></span>
    </div>
    <pre id="diagBox" style="margin-top:8px; display:none"></pre>
  </div>

<script>
  const BACKEND = "https://jesus-backend-production-1098.up.railway.app";

  const el = (id) => document.getElementById(id);
  const emailEl = el("email");
  const keyEl = el("admkey");
  const loadMsg = el("loadMsg");
  const sendMsg = el("sendMsg");
  const devBody = el("devBody");
  const chkAll = el("chkAll");
  const audEl = el("aud");
  const titleEl = el("title");
  const bodyEl = el("body");
  const countersEl = el("counters");
  const diagBox = el("diagBox");
  const btnDiag = el("btnDiag");

  let devices = [];

  function rowHTML(d, idx){
    const token20 = (d.fcm_token||"").slice(0,20) + "‚Ä¶";
    const isAndroid = /ANDROID_CHROME_/i.test(d.device_id||"");
    const platPill = `<span class="pill">${d.platform||"?"}</span> ${isAndroid ? '<span class="badge badge-android">ANDROID</span>' : '<span class="badge badge-desktop">DESKTOP</span>'}`;
    return `
      <tr>
        <td><input type="checkbox" data-idx="${idx}"></td>
        <td>${d.id}</td>
        <td>${d.device_id||""}</td>
        <td>${platPill}</td>
        <td class="muted">${d.last_seen||""}</td>
        <td class="muted" title="${d.fcm_token||""}">${token20}</td>
      </tr>
    `;
  }

  function renderTable(){
    devBody.innerHTML = devices.map((d,i)=>rowHTML(d,i)).join("");
    const androidCount = devices.filter(d => /ANDROID_CHROME_/i.test(d.device_id||"")).length;
    const desktopCount = devices.length - androidCount;
    countersEl.innerHTML = `
      <span class="badge badge-desktop">Desktop/Web: ${desktopCount}</span>
      &nbsp;
      <span class="badge badge-android">Android: ${androidCount}</span>
    `;
  }

  async function loadDevices(){
    sendMsg.textContent = "";
    devBody.innerHTML = "";
    devices = [];
    chkAll.checked = false;
    loadMsg.textContent = "Cargando‚Ä¶";
    diagBox.style.display = "none";
    try{
      // ‚ö†Ô∏è no-cache para evitar listas viejas
      const url = `${BACKEND}/users/push/devices?email=${encodeURIComponent(emailEl.value.trim())}&t=${Date.now()}`;
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();
      if(!j || j.ok === false){ throw new Error(j?.error || "Error al cargar"); }
      const raw = Array.isArray(j.devices) ? j.devices : [];

      // Normalizamos typos visibles (no cambia backend)
      devices = raw.map(d => {
        let device_id = d.device_id || "";
        if(/^ANDRID_CRHOME_/i.test(device_id)){
          device_id = device_id.replace(/^ANDRID_CRHOME_/i, "ANDROID_CHROME_");
        }
        return { ...d, device_id };
      });

      renderTable();
      loadMsg.innerHTML = `<span class="ok">OK</span> ${devices.length} dispositivos`;
    }catch(e){
      loadMsg.innerHTML = `<span class="err">Fallo</span> ${(e && e.message) || e}`;
    }
  }

  function selectedDevices(){
    if(audEl.value !== "selected") return devices;
    const checks = devBody.querySelectorAll('input[type="checkbox"][data-idx]');
    const out = [];
    checks.forEach(c => { if(c.checked){ out.push(devices[Number(c.dataset.idx)]); } });
    return out;
  }

  function audienceFilter(list){
    const mode = audEl.value;
    if(mode === "all" || mode === "selected") return list;
    if(mode === "web"){
      // Desktop/Web = todo lo que NO tenga ANDROID_CHROME_
      return list.filter(d => !/ANDROID_CHROME_/i.test(d.device_id||""));
    }
    if(mode === "android"){
      return list.filter(d => /ANDROID_CHROME_/i.test(d.device_id||""));
    }
    return list;
  }

  async function adminSendByToken(token, title, body, webDataOnly){
    const payload = {
      fcm_token: token,
      platform: "web",
      title,
      body,
      data: { act: "open_app" },
      webDataOnly
    };
    const r = await fetch(`${BACKEND}/users/push/admin-send`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8",
        "X-Admin-Key": keyEl.value.trim()
      },
      body: JSON.stringify(payload)
    });
    return r.json();
  }

  async function handleSend(){
    sendMsg.textContent = "Enviando‚Ä¶";
    const title = titleEl.value.trim() || "Notificaci√≥n";
    const body  = bodyEl.value.trim() || "";

    const baseList = selectedDevices();
    const list = audienceFilter(baseList);

    if(list.length === 0){
      sendMsg.innerHTML = `<span class="err">No hay dispositivos para ese destino.</span>`;
      return;
    }

    // üëá Log de qu√© device_ids se intentan (ayuda a ver si hay desktops)
    console.log("[ADMIN] Enviando a device_ids:", list.map(d => d.device_id));

    let targeted = 0, sent = 0, failed = 0;
    for(const d of list){
      if(!d.fcm_token) continue;
      targeted++;
      const isAndroid = /ANDROID_CHROME_/i.test(d.device_id||"");
      const webDataOnly = !isAndroid; // desktop=data-only, android=visible
      try{
        const resp = await adminSendByToken(d.fcm_token, title, body, webDataOnly);
        if(resp && resp.ok !== false){
          if(resp.sent > 0 || (resp.results && resp.results[0]?.ok)) sent++;
          else failed++;
        }else{
          failed++;
        }
      }catch{
        failed++;
      }
    }

    sendMsg.innerHTML = `<b>Resultado:</b> targeted=${targeted} ¬∑ sent=${sent} ¬∑ failed=${failed}`;
  }

  async function dumpRaw(){
    try{
      const url = `${BACKEND}/users/push/devices?email=${encodeURIComponent(emailEl.value.trim())}&t=${Date.now()}`;
      const r = await fetch(url, { cache: "no-store" });
      const j = await r.json();
      diagBox.style.display = "block";
      diagBox.textContent = JSON.stringify(j, null, 2);
    }catch(e){
      diagBox.style.display = "block";
      diagBox.textContent = "Error dump: " + (e?.message || e);
    }
  }

  // Eventos
  el("btnLoad").addEventListener("click", loadDevices);
  el("btnSend").addEventListener("click", handleSend);
  chkAll.addEventListener("change", () => {
    const checks = devBody.querySelectorAll('input[type="checkbox"][data-idx]');
    checks.forEach(c => c.checked = chkAll.checked);
  });
  btnDiag.addEventListener("click", dumpRaw);

  // Carga inicial
  loadDevices();
</script>

</body>
</html>
