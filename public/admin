<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Panel Admin Â· Notificaciones</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{color-scheme:dark light}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;margin:0;background:#0b0b0c;color:#eaeaea}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    .card{background:#131316;border:1px solid #2a2a32;border-radius:16px;padding:16px 16px}
    h1{font-size:20px;margin:0 0 8px}
    h2{font-size:16px;margin:20px 0 8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:820px){.row,.row3{grid-template-columns:1fr}}
    input,select,textarea,button{width:100%;box-sizing:border-box}
    input,select,textarea{background:#1a1a22;border:1px solid #34343f;color:#eaeaea;border-radius:10px;padding:10px 12px;outline:none}
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer;background:#2563eb;border:0;color:white;padding:10px 14px;border-radius:10px;font-weight:600}
    button.secondary{background:#374151}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{opacity:.8;font-size:13px}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
    .log{font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#0c0c0f;border:1px solid #2a2a32;border-radius:10px;padding:10px;white-space:pre-wrap}
    .tag{display:inline-block;background:#1f2937;border:1px solid #374151;color:#cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Panel de notificaciones (Admin)</h1>
      <div class="toolbar" style="margin:8px 0 12px">
        <span class="muted">Backend:</span>
        <input id="api" placeholder="https://jesus-backend-production-1098.up.railway.app" />
        <span class="muted">X-Admin-Key:</span>
        <input id="admkey" placeholder="clave secreta" />
        <button id="saveKey" class="secondary">Guardar clave</button>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button id="tabSingle">A usuarios especÃ­ficos</button>
        <button id="tabBroadcast" class="secondary">Broadcast</button>
      </div>

      <!-- SINGLE -->
      <section id="single">
        <h2>Destino</h2>
        <div class="row">
          <div>
            <label class="muted">Emails (coma separados)</label>
            <input id="emails" placeholder="usuario@dominio.com, otro@dominio.com" />
          </div>
          <div>
            <label class="muted">User IDs (coma separados, opcional)</label>
            <input id="userIds" placeholder="1,2,3" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label class="muted">Plataforma (opcional)</label>
            <select id="platform">
              <option value="">(todas)</option>
              <option value="web">web</option>
              <option value="android">android</option>
              <option value="ios">ios</option>
            </select>
          </div>
          <div>
            <label class="muted">device_id (opcional)</label>
            <input id="deviceId" placeholder="ANDROID_CHROME_XXXXXX / WEB_DESKTOP_XXXXXX" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label class="muted">fcm_token (opcional, envÃ­o directo a token)</label>
          <input id="fcmToken" placeholder="e.g. d0KOhDFI..." />
        </div>

        <h2>Mensaje</h2>
        <div class="row">
          <div>
            <label class="muted">TÃ­tulo</label>
            <input id="title" value="Aviso" />
          </div>
          <div>
            <label class="muted">URL (data.action=open_app)</label>
            <input id="url" value="/" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label class="muted">Cuerpo</label>
          <textarea id="body">Tenemos novedades para ti ðŸ™Œ</textarea>
        </div>
        <label class="pill" style="margin:8px 0 12px">
          <input type="checkbox" id="webDataOnly" checked />
          <span class="muted">Web (incluye Android PWA) como <b>data-only</b> (recomendado)</span>
        </label>

        <div class="toolbar">
          <button id="btnSendSingle">Enviar a esos usuarios</button>
          <button id="btnFillMe" class="secondary">Rellenar con mi email detectado</button>
          <span class="tag">Consejo: usa plataforma=<b>web</b> para Android PWA</span>
        </div>
      </section>

      <!-- BROADCAST -->
      <section id="broadcast" style="display:none">
        <h2>Segmento</h2>
        <div class="row">
          <div>
            <label class="muted">Plataforma</label>
            <select id="bcPlatform">
              <option value="">(todas)</option>
              <option value="web" selected>web</option>
              <option value="android">android</option>
              <option value="ios">ios</option>
            </select>
          </div>
          <div>
            <label class="muted">lastSeenDays</label>
            <input id="lastSeenDays" type="number" min="1" value="30" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label class="pill">
              <input type="checkbox" id="groupByUser" checked />
              <span class="muted">1 device por usuario</span>
            </label>
          </div>
          <div class="row">
            <div>
              <label class="muted">preferPrefix</label>
              <input id="preferPrefix" value="ANDROID_CHROME" />
            </div>
            <div>
              <label class="muted">limit</label>
              <input id="limit" type="number" min="1" value="500" />
            </div>
          </div>
        </div>

        <h2>Mensaje</h2>
        <div class="row">
          <div>
            <label class="muted">TÃ­tulo</label>
            <input id="bcTitle" value="Aviso" />
          </div>
          <div>
            <label class="muted">URL (data.action=open_app)</label>
            <input id="bcUrl" value="/" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label class="muted">Cuerpo</label>
          <textarea id="bcBody">Tenemos novedades para ti ðŸ™Œ</textarea>
        </div>
        <label class="pill" style="margin:8px 0 12px">
          <input type="checkbox" id="bcWebDataOnly" checked />
          <span class="muted">Web como <b>data-only</b> (recomendado)</span>
        </label>

        <div class="toolbar">
          <button id="btnSendBroadcast">Enviar broadcast</button>
        </div>
      </section>

      <h2>Log</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (v)=>{
    const pre = typeof v==='string' ? v : JSON.stringify(v,null,2);
    $('log').textContent += ( $('log').textContent ? "\n" : "" ) + pre;
  };
  const clearLog = ()=>{ $('log').textContent=''; };

  // Persistencia
  $('api').value = localStorage.getItem('admin_api') || 'https://jesus-backend-production-1098.up.railway.app';
  $('admkey').value = localStorage.getItem('admin_key') || '';
  $('saveKey').onclick = ()=>{
    localStorage.setItem('admin_api', $('api').value.trim());
    localStorage.setItem('admin_key', $('admkey').value.trim());
    log('âœ… Guardado');
  };

  // Tabs
  $('tabSingle').onclick = ()=>{
    $('single').style.display='block';
    $('broadcast').style.display='none';
    $('tabSingle').classList.remove('secondary');
    $('tabBroadcast').classList.add('secondary');
  };
  $('tabBroadcast').onclick = ()=>{
    $('single').style.display='none';
    $('broadcast').style.display='block';
    $('tabBroadcast').classList.remove('secondary');
    $('tabSingle').classList.add('secondary');
  };

  // Util
  function resolveEmail(){
    const w = window;
    return (w.__APP_EMAIL || localStorage.getItem('user_email') || 'info@movilive.com').toLowerCase();
  }
  $('btnFillMe').onclick = ()=>{
    $('emails').value = resolveEmail();
  };

  // Fetch helper
  async function post(path, payload, alsoPutInBody=false){
    const api = $('api').value.trim().replace(/\/+$/,'');
    const key = $('admkey').value.trim();
    if(!api){ throw new Error('missing_api');}
    if(!key){ throw new Error('missing_admin_key');}
    const headers = { 'Content-Type':'application/json; charset=utf-8', 'X-Admin-Key': key };
    const body = alsoPutInBody ? JSON.stringify(Object.assign({ admin_key:key }, payload)) : JSON.stringify(payload);
    const r = await fetch(api+path, { method:'POST', headers, body });
    const j = await r.json().catch(()=>({}));
    if(!r.ok || j?.ok===false){
      const err = j?.error || ('http_'+r.status);
      throw Object.assign(new Error(err), { response:j });
    }
    return j;
  }

  // SINGLE
  $('btnSendSingle').onclick = async ()=>{
    clearLog();
    try{
      const emails = $('emails').value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
      const userIds = $('userIds').value.split(',').map(s=>s.trim()).map(s=>s?Number(s):NaN).filter(n=>Number.isFinite(n));
      const platform = $('platform').value || undefined;
      const device_id = $('deviceId').value.trim() || undefined;
      const fcm_token = $('fcmToken').value.trim() || undefined;

      const payloadBase = {
        title: $('title').value,
        body: $('body').value,
        data: { action:'open_app', url: $('url').value },
        webDataOnly: $('webDataOnly').checked
      };
      if(platform) payloadBase.platform = platform;
      if(device_id) payloadBase.device_id = device_id;
      if(fcm_token) payloadBase.fcm_token = fcm_token;

      let targets = 0, sent=0, failed=0;

      // por token directo (1 tiro)
      if (fcm_token){
        targets++;
        log({ sending: { ...payloadBase, fcm_token: '***' }});
        try{
          const r = await post('/users/push/send-simple', payloadBase);
          sent += r?.sent||0; failed += r?.failed||0;
          log({ ok:true, r });
        }catch(e){ failed++; log({ error: e.message, resp: e.response }); }
      }

      // por emails
      for (const email of emails){
        targets++;
        const p = { ...payloadBase, email };
        log({ sending: p });
        try{
          const r = await post('/users/push/send-simple', p);
          sent += r?.sent||0; failed += r?.failed||0;
          log({ ok:true, r });
        }catch(e){ failed++; log({ error: e.message, resp: e.response }); }
      }

      // por user_ids
      for (const uid of userIds){
        targets++;
        const p = { ...payloadBase, user_id: uid };
        log({ sending: p });
        try{
          const r = await post('/users/push/send-simple', p);
          sent += r?.sent||0; failed += r?.failed||0;
          log({ ok:true, r });
        }catch(e){ failed++; log({ error: e.message, resp: e.response }); }
      }

      log(`\n==> FIN :: targeted=${targets} sent=${sent} failed=${failed}`);
    }catch(e){
      log({ error: e.message });
    }
  };

  // BROADCAST
  $('btnSendBroadcast').onclick = async ()=>{
    clearLog();
    try{
      const payload = {
        title: $('bcTitle').value,
        body: $('bcBody').value,
        data: { action:'open_app', url: $('bcUrl').value },
        webDataOnly: $('bcWebDataOnly').checked,
        platform: $('bcPlatform').value || undefined,
        last_seen_days: Number($('lastSeenDays').value) || 30,
        group_by_user: $('groupByUser').checked,
        prefer_prefix: $('preferPrefix').value || 'ANDROID_CHROME',
        limit: Number($('limit').value) || 500
      };
      log({ sending: payload });
      // tambiÃ©n pone admin_key en body para compatibilidad con tu backend actual
      const r = await post('/users/push/broadcast', payload, true);
      log({ ok:true, r });
    }catch(e){
      log({ error: e.message, resp: e.response });
    }
  };

})();
</script>
</body>
</html>
